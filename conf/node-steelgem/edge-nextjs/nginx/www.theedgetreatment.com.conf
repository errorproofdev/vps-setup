upstream edge_nextjs {
    server 127.0.0.1:3000;
    keepalive 64;
}

# HTTP -> HTTPS redirect
server {
    listen 80;
    listen [::]:80;
    server_name theedgetreatment.com;

    # Allow Let's Encrypt challenges
    location /.well-known/acme-challenge/ {
        root /var/www/letsencrypt;
    }

    location / {
        return 301 https://www.$server_name$request_uri;
    }
}

server {
server_name www.theedgetreatment.com;
  listen 80;

# Proxy all other requests to Node
  location / {
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
     }


}


server {
    # Redirect non-www HTTPS traffic to www HTTPS
    server_name theedgetreatment.com;
listen 443 ssl;
listen [::]:443 ssl;

http2 on;


      ssl_certificate /etc/ssl/certs/cloudflare-origin-fullchain.pem;
  ssl_certificate_key /etc/ssl/key.pem;

    location / {
        return 301 https://www.$server_name$request_uri;
    }

}


# Main HTTPS app server (NO redirects here)
server {
listen 443 ssl;
listen [::]:443 ssl;

http2 on;
    server_name www.theedgetreatment.com;

    ssl_certificate /etc/ssl/certs/cloudflare-origin-fullchain.pem;
  ssl_certificate_key /etc/ssl/key.pem;

    # Security + performance
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Actual app root (static assets)
    root /home/ubuntu/current/public;

    # Try static files â†’ Node fallback
    location / {
        try_files $uri @nextjs;
    }

    location @nextjs {
        proxy_pass http://edge_nextjs;

        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

