# ============================================================================
# UPSTREAM DEFINITIONS - Unix Socket Proxying
# ============================================================================

upstream detoxnearme {
    # Proxy to localhost TCP port (apps listen on localhost:3000)
    server 127.0.0.1:3000;
    keepalive 64;
}

upstream edge_treatment {
    server 127.0.0.1:3001;
    keepalive 64;
}

upstream forge_recovery {
    server 127.0.0.1:3002;
    keepalive 64;
}

# ============================================================================
# DetoxNearMe - https://detoxnearme.com
# ============================================================================

server {
    listen 80;
    listen [::]:80;
    server_name detoxnearme.com www.detoxnearme.com;
    
    # HTTP → HTTPS redirect
    location / {
        return 301 https://detoxnearme.com$request_uri;
    }
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.detoxnearme.com;
    
    ssl_certificate /etc/ssl/detoxnearme/cert.pem;
    ssl_certificate_key /etc/ssl/detoxnearme/key.pem;
    
    # www → root domain redirect
    location / {
        return 301 https://detoxnearme.com$request_uri;
    }
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name detoxnearme.com;
    
    ssl_certificate /etc/ssl/detoxnearme/cert.pem;
    ssl_certificate_key /etc/ssl/detoxnearme/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Client limits (prevent abuse)
    client_max_body_size 10m;
    client_body_timeout 12;
    client_header_timeout 12;
    keepalive_timeout 15;
    send_timeout 10;
    
    # Proxy to Unix socket
    location / {
        proxy_pass http://detoxnearme;
        proxy_http_version 1.1;
        
        # Required for Unix socket connections
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket support for Next.js HMR
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Timeouts for socket communication
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffering (important for large responses)
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 24 4k;
        
        # Connection handling
        proxy_set_header Connection "";
    }
    
    # Static assets (Next.js .next/static)
    location /_next/static/ {
        alias /var/www/apps/detoxnearme/.next/static/;
        expires 365d;
        add_header Cache-Control "public, immutable";
    }
    
    # Favicon
    location = /favicon.ico {
        access_log off;
        log_not_found off;
    }
    
    # Robots.txt
    location = /robots.txt {
        access_log off;
        log_not_found off;
    }
}

# ============================================================================
# Edge Treatment - https://www.theedgetreatment.com
# ============================================================================

server {
    listen 80;
    listen [::]:80;
    server_name theedgetreatment.com www.theedgetreatment.com;
    
    location / {
        return 301 https://www.theedgetreatment.com$request_uri;
    }
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name theedgetreatment.com;
    
    ssl_certificate /etc/ssl/edge/cert.pem;
    ssl_certificate_key /etc/ssl/edge/key.pem;
    
    # Redirect root to www
    location / {
        return 301 https://www.theedgetreatment.com$request_uri;
    }
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.theedgetreatment.com;
    
    ssl_certificate /etc/ssl/edge/cert.pem;
    ssl_certificate_key /etc/ssl/edge/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    client_max_body_size 10m;
    client_body_timeout 12;
    client_header_timeout 12;
    keepalive_timeout 15;
    send_timeout 10;
    
    # Proxy to Unix socket
    location / {
        proxy_pass http://edge_treatment;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 24 4k;
    }
    
    location /_next/static/ {
        alias /var/www/apps/edge-nextjs/.next/static/;
        expires 365d;
        add_header Cache-Control "public, immutable";
    }
}

# ============================================================================
# Forge Recovery - https://www.theforgerecovery.com
# ============================================================================

server {
    listen 80;
    listen [::]:80;
    server_name theforgerecovery.com www.theforgerecovery.com;
    
    location / {
        return 301 https://theforgerecovery.com$request_uri;
    }
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.theforgerecovery.com;
    
    ssl_certificate /etc/ssl/forge/cert.pem;
    ssl_certificate_key /etc/ssl/forge/key.pem;
    
    # www → root domain redirect
    location / {
        return 301 https://theforgerecovery.com$request_uri;
    }
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name theforgerecovery.com;
    
    ssl_certificate /etc/ssl/forge/cert.pem;
    ssl_certificate_key /etc/ssl/forge/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    client_max_body_size 10m;
    client_body_timeout 12;
    client_header_timeout 12;
    keepalive_timeout 15;
    send_timeout 10;
    
    # Proxy to app
    location / {
        proxy_pass http://forge_recovery;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 24 4k;
    }
  
    location /_next/static/ {
        alias /var/www/apps/forge-nextjs/.next/static/;
        expires 365d;
        add_header Cache-Control "public, immutable";
    }
}

# ============================================================================
# VERIFICATION - Check that apps are listening and NGINX can reach them
# ============================================================================
# 
# Run this to verify the setup is working:
# 
# #!/bin/bash
# echo "=== Checking apps are listening on TCP ports ==="
# netstat -tlnp | grep node
# # Should show:
# # tcp 0 0 127.0.0.1:3000 0.0.0.0:* LISTEN
# # tcp 0 0 127.0.0.1:3001 0.0.0.0:* LISTEN
# # tcp 0 0 127.0.0.1:3002 0.0.0.0:* LISTEN
#
# echo ""
# echo "=== Testing NGINX can reach apps ==="
# curl -I http://127.0.0.1:3000  # Should get response from detoxnearme app
# curl -I http://127.0.0.1:3001  # Should get response from edge app
# curl -I http://127.0.0.1:3002  # Should get response from forge app
#
# echo ""
# echo "=== Check NGINX error log for connection issues ==="
# sudo tail -20 /var/log/nginx/error.log
#
# echo ""
# echo "=== Verify firewall blocks external access to app ports ==="
# sudo ufw status | grep -E "3000|3001|3002"
#
